name: Tauri Release

on:
    push:
        tags:
            - "v*" # v1.0.0 / v0.1.0-beta Á≠â
    workflow_dispatch:

jobs:
    build:
        permissions:
            contents: write

        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: windows-latest
                      target: x86_64-pc-windows-msvc
                    - platform: macos-latest
                      target: x86_64-apple-darwin
                    - platform: macos-latest
                      target: aarch64-apple-darwin
                    - platform: ubuntu-latest
                      target: x86_64-unknown-linux-gnu

        runs-on: ${{ matrix.platform }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: frontend/package.json

            - name: Setup Rust
              uses: actions-rust-lang/setup-rust-toolchain@v1
              with:
                  target: ${{ matrix.target }}

            - name: Fix Ubuntu package sources
              if: matrix.platform == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y --no-install-recommends software-properties-common
                  sudo add-apt-repository universe
                  sudo apt-get update

            - name: Install dependencies (Ubuntu)
              if: matrix.platform == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y --no-install-recommends libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

            - name: Install frontend dependencies
              working-directory: frontend
              run: npm install

            - name: Update version in all config files
              shell: bash
              run: |
                  VERSION="${{ github.ref_name }}"
                  VERSION="${VERSION#v}"  # ÁßªÈô§ v ÂâçÁºÄ
                  
                  # Êõ¥Êñ∞ tauri.conf.json
                  sed -i.bak "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" frontend/src-tauri/tauri.conf.json
                  
                  # Êõ¥Êñ∞ Cargo.toml
                  sed -i.bak "s/^version = \"[^\"]*\"/version = \"$VERSION\"/" frontend/src-tauri/Cargo.toml
                  
                  # Êõ¥Êñ∞ package.json
                  sed -i.bak "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" frontend/package.json
                  
                  # È™åËØÅÊõ¥Êñ∞ÁªìÊûú
                  echo "=== Updated versions ==="
                  echo "tauri.conf.json:"
                  grep '"version":' frontend/src-tauri/tauri.conf.json
                  echo "Cargo.toml:"
                  grep '^version =' frontend/src-tauri/Cargo.toml
                  echo "package.json:"
                  grep '"version":' frontend/package.json | head -1

            - name: Build & Release Tauri App
              uses: tauri-apps/tauri-action@v0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  projectPath: frontend
                  tagName: ${{ github.ref_name }}
                  releaseName: "Release ${{ github.ref_name }}"
                  releaseBody: |
                      üìù Auto-generated release for ${{ matrix.platform }}

                      - Built with Tauri
                      - Frontend: Vue3 + Vite
                      - Backend: Rust + SQLite

                      **Downloads:**
                      - Windows: `.msi` installer and `.exe` portable
                      - macOS: `.dmg` installer and `.app` bundle
                      - Linux: `.deb`, `.AppImage`
                  prerelease: false
                  includeRelease: true
                  includeDebug: false

            - name: Delete older releases
              if: matrix.platform == 'windows-latest'
              uses: dev-drprasad/delete-older-releases@v0.3.2
              with:
                  keep_latest: 2
                  delete_tags: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
