name: Tauri Release

on:
    push:
        tags:
            - "v*" # v1.0.0 / v0.1.0-beta ç­‰
    workflow_dispatch:

jobs:
    build:
        permissions:
            contents: write

        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: windows-latest
                      target: x86_64-pc-windows-msvc
                    - platform: macos-latest
                      target: x86_64-apple-darwin
                    - platform: macos-latest
                      target: aarch64-apple-darwin
                    - platform: ubuntu-latest
                      target: x86_64-unknown-linux-gnu

        runs-on: ${{ matrix.platform }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: frontend/package.json

            - name: Install jq (JSON processor)
              shell: bash
              run: |
                  if [[ "${{ matrix.platform }}" == "ubuntu-latest" ]]; then
                      sudo apt-get install -y jq
                  elif [[ "${{ matrix.platform }}" == "macos-latest" ]]; then
                      brew install jq
                  elif [[ "${{ matrix.platform }}" == "windows-latest" ]]; then
                      choco install jq -y
                  fi

            - name: Setup Rust
              uses: actions-rust-lang/setup-rust-toolchain@v1
              with:
                  target: ${{ matrix.target }}

            - name: Fix Ubuntu package sources
              if: matrix.platform == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y --no-install-recommends software-properties-common
                  sudo add-apt-repository universe
                  sudo apt-get update

            - name: Install dependencies (Ubuntu)
              if: matrix.platform == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y --no-install-recommends libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

            - name: Install frontend dependencies
              working-directory: frontend
              run: npm install

            - name: Update version in all config files
              shell: bash
              run: |
                  VERSION="${{ github.ref_name }}"
                  VERSION="${VERSION#v}"  # ç§»é™¤ v å‰ç¼€

                  echo "Updating to version: $VERSION"

                  # macOS/Linux ä½¿ç”¨ sed -i ''ï¼ŒWindows Git Bash ä½¿ç”¨ sed -i
                  if [[ "$OSTYPE" == "darwin"* ]]; then
                      # macOS
                      sed -i '' "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" frontend/src-tauri/tauri.conf.json
                      sed -i '' "s/^version = \"[^\"]*\"/version = \"$VERSION\"/" frontend/src-tauri/Cargo.toml
                      sed -i '' "1,/\"version\": \"[^\"]*\"/ s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" frontend/package.json
                  else
                      # Linux/Windows
                      sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" frontend/src-tauri/tauri.conf.json
                      sed -i "s/^version = \"[^\"]*\"/version = \"$VERSION\"/" frontend/src-tauri/Cargo.toml
                      sed -i "1,/\"version\": \"[^\"]*\"/ s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" frontend/package.json
                  fi

                  # éªŒè¯æ›´æ–°ç»“æœ
                  echo "=== Updated versions ==="
                  echo "tauri.conf.json:"
                  grep '"version":' frontend/src-tauri/tauri.conf.json
                  echo "Cargo.toml:"
                  grep '^version =' frontend/src-tauri/Cargo.toml
                  echo "package.json:"
                  grep '"version":' frontend/package.json | head -1

            - name: Configure bundle targets
              shell: bash
              working-directory: frontend/src-tauri
              run: |
                  # è¯»å–å½“å‰é…ç½®
                  CONFIG_FILE="tauri.conf.json"

                  # æ ¹æ®å¹³å°è®¾ç½®ä¸åŒçš„ bundle targets
                  if [[ "${{ matrix.platform }}" == "ubuntu-latest" ]]; then
                      # Linux: deb å’Œ rpmï¼Œç§»é™¤ AppImage
                      echo "Configuring Linux bundle targets: deb, rpm"
                      # ä½¿ç”¨ jq æˆ– sed ä¿®æ”¹é…ç½®ï¼ˆè¿™é‡Œç”¨ç®€å•çš„æ–¹å¼ï¼Œç›´æ¥æ·»åŠ  targetsï¼‰
                      cat > bundle_config.json << 'EOF'
                  {
                      "bundle": {
                          "targets": ["deb", "rpm"]
                      }
                  }
                  EOF
                  elif [[ "${{ matrix.platform }}" == "windows-latest" ]]; then
                      # Windows: åªä¿ç•™ msiï¼Œç§»é™¤ nsis (setup.exe)
                      echo "Configuring Windows bundle targets: msi only"
                      cat > bundle_config.json << 'EOF'
                  {
                      "bundle": {
                          "targets": ["msi"]
                      }
                  }
                  EOF
                  elif [[ "${{ matrix.platform }}" == "macos-latest" ]]; then
                      # macOS: ä¿ç•™ dmg å’Œ app
                      echo "Configuring macOS bundle targets: dmg, app"
                      cat > bundle_config.json << 'EOF'
                  {
                      "bundle": {
                          "targets": ["dmg", "app"]
                      }
                  }
                  EOF
                  fi

                  # åˆå¹¶é…ç½®åˆ° tauri.conf.json
                  if command -v jq &> /dev/null; then
                      jq -s '.[0] * .[1]' "$CONFIG_FILE" bundle_config.json > tmp.json && mv tmp.json "$CONFIG_FILE"
                      rm bundle_config.json
                      echo "=== Updated bundle targets ==="
                      jq '.bundle.targets' "$CONFIG_FILE"
                  else
                      echo "jq not found, skipping bundle target configuration"
                  fi

            - name: Build & Release Tauri App
              uses: tauri-apps/tauri-action@v0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
                  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
              with:
                  projectPath: frontend
                  tagName: ${{ github.ref_name }}
                  releaseName: "Release ${{ github.ref_name }}"
                  releaseBody: |
                      ğŸ“ Auto-generated release for ${{ matrix.platform }}

                      - Built with Tauri
                      - Frontend: Vue3 + Vite
                      - Backend: Rust + SQLite

                      **Downloads:**
                      - Windows: `.msi` installer and `.exe` portable
                      - macOS: `.dmg` installer and `.app` bundle
                      - Linux: `.deb`, `.AppImage`

                      **è‡ªåŠ¨æ›´æ–°æ”¯æŒ**: åº”ç”¨å†…æ£€æŸ¥æ›´æ–°åŠŸèƒ½å·²å¯ç”¨
                  prerelease: false
                  includeRelease: true
                  includeDebug: false
                  # å…³é”®ï¼šç¡®ä¿ç”Ÿæˆ updater artifacts å’Œ latest.json
                  includeUpdaterJson: true
                  updaterJsonKeepUniversal: true
                  updaterJsonPreferNsis: false

            - name: Delete older releases
              if: matrix.platform == 'windows-latest'
              uses: dev-drprasad/delete-older-releases@v0.3.2
              with:
                  keep_latest: 2
                  delete_tags: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
